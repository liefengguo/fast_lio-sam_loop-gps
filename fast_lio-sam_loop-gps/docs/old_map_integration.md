# Old Map Integration Notes

> 目标：支持在启动时加载已有地图，并把旧关键帧与新的增量建图逻辑区分开，同时让传感器/回环模块按需复用这些历史数据。

## 1. 读取 pose_graph.g2o 的新流程

### 做了什么
- `LoadMap_gtsam()` 使用 `gtsam::readG2o()` 读出完整的 `NonlinearFactorGraph` 与 `Values`。
- 解析所有位姿节点，把姿态写回 `cloud_key_poses_3D/6D`，并同步副本 `copy_*`、未优化缓存等。
- 读取 `EDGE_DIS:VEC3` 行，构造 `gtsam::GPSFactor`，补充进运行时的 GPS 因子集合与索引表。
- 将旧图的因子与初值推入 `ISAM2`，随后用 `Constrained` 噪声给每个已有节点加先验，锁定旧节点。

### 为什么要这样做
- 通过 `readG2o` 拿到完整图结构，才能复原 pose+factor 的前后关系。
- 重新填充关键帧点云数组后，后端/可视化才能在第一帧之前直接使用旧位姿。
- GPS 因子与索引保持一致，避免旧图信息被重复添加。
- 对旧节点加零协方差先验可把旧图视为“基准真值”，只优化新增节点，符合“旧地图固定、新地图增量优化”的需求。

## 2. 加载旧关键帧点云与原始地图

### 做了什么
- 遍历 `Map/pcd_buffer/*.pcd`，加载每个关键帧的局部点云，填入 `surf_cloud_keyframes` 与 `laser_cloud_raw_keyframes`。
- 读取 `Map/raw_map.pcd`，存入 `preloaded_raw_map`，并设置 `raw_map_needs_publish` 标记。
- 在主程序初始化 publisher 后调用 `PublishPreloadedRawMap()`，若有订阅者则立即发布原始地图。
- `publish_global_map()` 每次执行前会尝试触发一次原始地图发布；若仅发布 raw map 且无新的订阅需求则直接返回。

### 为什么要这样做
- 旧关键帧点云可以直接用于局部地图构建、回环匹配，在新节点存在之前即可恢复原有地图。
- `raw_map.pcd` 提供的是整个地图的稠密点云，首帧即发布可以在 RViz 中即时看到历史地图。
- 通过延迟到有订阅者时再发布，避免在没有可视化需求时浪费带宽。

## 3. 回环索引的管理策略

### 做了什么
- `loop_Index_container` 在加载旧图后按节点索引填充自环（key→key），并根据图中的 `BetweenFactor` 记录旧回环。
- 初始化时清空 `loop_Index_queue`、`loop_pose_queue`、`loop_noise_queue`，防止重复触发旧回环。
- 新增循环时先检查容器，避免对旧节点重复添加约束。
- 在 `visualize_loop_closure()` 中增加边界检查和 key 相等判定，杜绝越界访问。

### 为什么要这样做
- 对旧节点设置自环标记，可用来快速判断“这是旧图节点”，后续逻辑避免对其重复回环检测与添加。
- 迁移旧图时保持历史回环记录，可用于可视化与后端判断。
- 添加边界检查可防止因加载数据不完整导致的访问越界崩溃。

## 4. 新旧关键帧区分与里程计因子的改写

### 做了什么
- 在 `add_odom_factor()` / `add_odom_factor_fastlio()` 内根据 `old_map_keyframe_count` 判断“第一帧新节点”。
- 对第一帧新节点添加零姿态先验（单位姿态），而不是直接接续旧图末尾的估计。
- `add_gps_factor()` 会跳过旧节点数量，确保新 GPS 因子只关联新增关键帧。

### 为什么要这样做
- 第一帧新节点如果沿用旧图尾帧做基准，会把旧地图位姿误认为当前起点，导致后续轨迹整体偏移。
- 置零先验让新会话以当前传感器估计为基准重建，同时旧图保持锁定。
- GPS 因子若重复作用于旧节点会造成权重被重复利用，产生不可控的优化偏置。

## 5. 可视化与导出流程的健壮性

### 做了什么
- 在遍历点云向量时增加索引合法性判断 (`thisKeyInd < surf_cloud_keyframes.size()` 等)。
- 保存地图/回环可视化时如缺少对应点云则跳过，防止访问空指针。
- `save_map_service()` 生成地图前先检查点云指针是否初始化。

### 为什么要这样做
- 旧图可能缺失部分关键帧点云，新代码必须容错，避免一次访问失败导致系统崩溃。
- 跳过无效点云时给出日志提醒，便于后续排查数据缺失原因。

## 6. 目录镜像与文件拷贝

### 做了什么
- `copy_directory_recursively()` 用于把输入的地图目录镜像到运行目录的 `Map/`。
- 如果目标目录已存在会先删除再复制，保证运行目录中的数据与输入保持一致。

### 为什么要这样做
- 运行过程中写出的 `pose_graph.g2o`、`pcd_buffer` 等文件默认落在 `Map/`，镜像后可与加载数据对齐，避免路径混乱。
- 复制失败会给出警告，但不阻断后续加载流程，以免因权限/磁盘原因导致整个程序退出。

---

以上步骤共同确保：
1. 启动后立即加载旧图并发布已有地图信息；
2. 新数据只在旧图的约束基础上增量优化；
3. 各模块能安全地复用历史点云/回环信息，不会因数据缺失或索引错误崩溃；
4. 原始地图保留在 `Map/`，可继续导出或增量更新。
